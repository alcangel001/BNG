{% extends 'bingo_app/base.html' %}
{% load bingo_filters %}

{% block title %}Lobby Premium - Bingo Kuzu{% endblock %}

{% block extra_css %}
<style>
    /* Estilo Premium Mejorado */
    .lobby-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .lobby-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        background: linear-gradient(135deg, #2C3E50 0%, #1A252F 100%);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .lobby-header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(231,76,60,0.1) 0%, transparent 70%);
        z-index: 0;
    }
    
    .game-card {
        background: linear-gradient(145deg, #2C3E50 0%, #34495E 100%);
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: none;
        position: relative;
        z-index: 1;
    }
    
    .game-card::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #E74C3C 0%, #F39C12 100%);
    }
    
    .game-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0,0,0,0.5);
    }
    
    .game-card.joined {
        border-left: 4px solid #2ECC71;
    }
    
    .game-header {
        background: rgba(0,0,0,0.2);
        color: white;
        padding: 1.2rem 1.5rem;
        position: relative;
    }
    
    .game-header h3 {
        font-weight: 600;
        letter-spacing: 0.5px;
        margin: 0;
        position: relative;
        z-index: 2;
    }
    
    .game-body {
        padding: 1.8rem;
        color: #ECF0F1;
        position: relative;
    }
    
    .game-footer {
        padding: 1.2rem 1.5rem;
        background: rgba(0,0,0,0.25);
        border-top: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .prize-amount {
        color: #F1C40F;
        font-weight: 700;
        font-size: 1.3rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .price-tag {
        background: rgba(0,0,0,0.4);
        border-radius: 20px;
        padding: 5px 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        color: white;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .card-price {
        background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
    }
    
    .info-card {
        background: linear-gradient(145deg, #2C3E50 0%, #34495E 100%);
        border-radius: 15px;
        padding: 1.8rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        color: #ECF0F1;
        position: relative;
        overflow: hidden;
    }
    
    .info-card::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(52,152,219,0.1) 0%, transparent 70%);
        z-index: 0;
    }
    
    .info-card-header {
        font-weight: 600;
        font-size: 1.3rem;
        margin-bottom: 1.5rem;
        color: white;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        position: relative;
        z-index: 2;
    }
    
    .no-games {
        text-align: center;
        padding: 3rem;
        background: linear-gradient(145deg, #2C3E50 0%, #34495E 100%);
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        color: white;
    }
    
    .no-games h4 {
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .progress {
        background: rgba(0,0,0,0.3);
        height: 10px;
        border-radius: 5px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #F1C40F 0%, #F39C12 100%);
        border-radius: 5px;
    }
    
    .join-button {
        background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none !important;
    }
    
    .join-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 7px 20px rgba(231, 76, 60, 0.6);
        color: white;
    }
    
    .join-button i {
        margin-right: 8px;
    }
    
    .user-balance-badge {
        background: linear-gradient(135deg, #16A085 0%, #1ABC9C 100%);
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 8px 15px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(22, 160, 133, 0.4);
        display: inline-flex;
        align-items: center;
        text-decoration: none !important;
    }
    
    .user-balance-badge i {
        margin-right: 8px;
    }
    
    .game-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        color: white;
        margin-left: 8px;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .bg-success {
        background: linear-gradient(135deg, #27AE60 0%, #2ECC71 100%) !important;
    }
    
    .bg-warning {
        background: linear-gradient(135deg, #F39C12 0%, #F1C40F 100%) !important;
    }
    
    .bg-secondary {
        background: linear-gradient(135deg, #7F8C8D 0%, #95A5A6 100%) !important;
    }
    
    hr.divider {
        border: none;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
        margin: 1.5rem 0;
    }
    
    .game-feature {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .game-feature i {
        width: 24px;
        text-align: center;
        margin-right: 10px;
        color: #F1C40F;
    }
    
    .feature-label {
        flex: 1;
    }
    
    .feature-value {
        font-weight: 600;
    }
    
    /* Fix para los botones clickeables */
    a.join-button, a.user-balance-badge {
        position: relative;
        z-index: 2;
    }
    
    /* Asegurar que los enlaces sean clickeables */
    .clickable {
        position: relative;
        z-index: 2;
    }
    
    @media (max-width: 768px) {
        .lobby-header {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }
        
        .game-card {
            margin-bottom: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="lobby-container">
    <div class="lobby-header">
        <div class="clickable">
            <h1 class="mb-2"><i class="fas fa-dice me-2"></i>Lobby Premium</h1>
            <p class="mb-0">Únete a las mejores partidas de bingo online</p>
        </div>
        <div class="d-flex align-items-center clickable">
            <a href="#" class="user-balance-badge me-3">
                <i class="fas fa-coins"></i>{{ user.credit_balance }} créditos
            </a>
            {% if user.is_organizer %}
            <a href="{% url 'create_game' %}" class="join-button">
                <i class="fas fa-plus"></i>Crear Sala
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <h2 class="text-white mb-4"><i class="fas fa-gamepad me-2"></i>Salas Disponibles</h2>
            
            {% if games %}
            <div class="row">
                {% for game in games %}
                {% with is_joined=request.user|is_player_in_game:game %}
                <div class="col-md-6">
                    <div class="game-card {% if is_joined %}joined{% endif %}">
                        <div class="game-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3>{{ game.name }}</h3>
                                <div class="d-flex">
                                    {% if game.password %}
                                    <span class="game-badge" title="Sala con contraseña">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    {% endif %}
                                    {% if is_joined %}
                                    <span class="game-badge" title="Ya estás en esta partida">
                                        <i class="fas fa-check"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="game-body">
                            <div class="game-feature">
                                <i class="fas fa-user"></i>
                                <span class="feature-label">Organizador:</span>
                                <span class="feature-value">{{ game.organizer.username }}</span>
                            </div>
                            
                            <div class="game-feature">
                                <i class="fas fa-users"></i>
                                <span class="feature-label">Jugadores:</span>
                                <span class="feature-value">{{ game.player_set.count }}</span>
                            </div>

                            <div class="game-feature">
                                <i class="fas fa-chess-board"></i>
                                <span class="feature-label">Patrón ganador:</span>
                                <span class="feature-value">
                                    {% if game.winning_pattern == 'CUSTOM' %}
                                        Personalizado
                                    {% else %}
                                        {{ game.get_winning_pattern_display }}
                                    {% endif %}
                                </span>
                            </div>

                            
                            <div class="game-feature">
                                <i class="fas fa-trophy"></i>
                                <span class="feature-label">Premio:</span>
                                <span class="feature-value prize-amount">{{ game.current_prize }} créditos</span>
                            </div>
                            
                            {% if game.progressive_prizes %}
                            <div class="mt-3 mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Progreso del premio</small>
                                    <small>{{ game.progress_percentage }}%</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: {{ game.progress_percentage }}%"></div>
                                </div>
                                <small class="text-muted d-block text-center mt-1">
                                    {{ game.total_cards_sold }} / {{ game.next_prize_target }} cartones vendidos
                                </small>
                            </div>
                            {% endif %}
                            
                            <hr class="divider">
                            
                            <div class="game-feature">
                                <i class="fas fa-layer-group"></i>
                                <span class="feature-label">Cartones extra:</span>
                                <span class="feature-value price-tag card-price">{{ game.card_price }} créditos</span>
                            </div>
                        </div>
                        
                        <div class="game-footer">
                            <span class="status-badge {% if game.is_finished %}bg-secondary{% elif game.is_started %}bg-warning{% else %}bg-success{% endif %}">
                                {% if game.is_finished %}Terminada{% elif game.is_started %}En curso{% else %}Esperando{% endif %}
                            </span>
                            
                            {% if is_joined %}
                            <a href="{% url 'game_room' game.id %}" class="join-button" style="background: linear-gradient(135deg, #27AE60 0%, #2ECC71 100%); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);">
                                <i class="fas fa-door-open"></i>Entrar
                            </a>
                            {% else %}
                            <a href="{% url 'game_room' game.id %}" class="join-button">
                                <i class="fas fa-sign-in-alt"></i>Unirse
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            {% else %}
            <div class="no-games">
                <i class="fas fa-game-board fa-3x mb-3" style="color: rgba(255,255,255,0.1);"></i>
                <h4>No hay salas disponibles actualmente</h4>
                <p class="text-muted mb-4">Sé el primero en crear una emocionante partida</p>
                {% if user.is_organizer %}
                <a href="{% url 'create_game' %}" class="join-button">
                    <i class="fas fa-plus"></i>Crear Sala
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-user me-2"></i>Tu Perfil
                </div>
                <div class="text-center mb-4">
                    <div class="user-balance-badge mb-3" style="display: inline-flex;">
                        <i class="fas fa-coins"></i>{{ user.credit_balance }} créditos
                    </div>
                    <a href="{% url 'request_credits' %}" class="join-button" style="background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);">
                        <i class="fas fa-plus-circle"></i>Solicitar créditos
                    </a>
                </div>
                
                <hr class="divider">
                
                <div class="info-card-header">
                    <i class="fas fa-chart-line me-2"></i>Estadísticas
                </div>
                <div class="game-feature">
                    <i class="fas fa-gamepad"></i>
                    <span class="feature-label">Partidas jugadas:</span>
                    <span class="feature-value">{{ user.player_set.count }}</span>
                </div>
                <div class="game-feature">
                    <i class="fas fa-trophy"></i>
                    <span class="feature-label">Victorias:</span>
                    <span class="feature-value">{{ wins_count }}</span>
                </div>
                {% if user.is_organizer %}
                <div class="game-feature">
                    <i class="fas fa-crown"></i>
                    <span class="feature-label">Salas creadas:</span>
                    <span class="feature-value">{{ user.organized_games.count }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-question-circle me-2"></i>Cómo Jugar
                </div>
                <div class="mb-4">
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-ticket-alt me-2" style="color: #F39C12;"></i>
                        <span>Participación</span>
                    </h5>
                    <ul class="list-unstyled ps-4">
                        <li class="mb-2"><i class="fas fa-check-circle me-2" style="color: #2ECC71;"></i>Únete gratis a cualquier sala</li>
                        <li><i class="fas fa-check-circle me-2" style="color: #2ECC71;"></i>Compra cartones adicionales si lo deseas</li>
                    </ul>
                </div>
                <div>
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-award me-2" style="color: #F1C40F;"></i>
                        <span>Premios</span>
                    </h5>
                    <ul class="list-unstyled ps-4">
                        <li class="mb-2"><i class="fas fa-check-circle me-2" style="color: #2ECC71;"></i>Gana cuando completes el patrón</li>
                        <li class="mb-2"><i class="fas fa-check-circle me-2" style="color: #2ECC71;"></i>Premios en créditos instantáneos</li>
                        <li><i class="fas fa-check-circle me-2" style="color: #2ECC71;"></i>Premios progresivos disponibles</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Todos los botones de unirse ahora redirigen directamente sin validación de saldo
    document.querySelectorAll('.join-game-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const gameId = this.dataset.gameId;
            window.location.href = `{% url 'game_room' 0 %}`.replace('0', gameId);
        });
    });
});
</script>
{% endblock %}